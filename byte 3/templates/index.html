<!DOCTYPE html>
<html>
<head>
	<title>Byte 2</title>
  	<link href="stylesheets/d3.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="d3/d3.v3.js"></script>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>



</head>

<body>
	<div class="navbar navbar-default">
		<div class="container">
			<h3 class="navbar-header">Byte 2</h3>
		</div>

	<div id="tooltip" class="hidden">
       <p><strong>Number of Animals:</strong></p>
       <p><span id="value">100</span></p>
    </div>
		
	</div>
	<div class="container">
			<script>

   // ----------- EVERY CHART NEEDS DATA --------------
   // this is the data we passed from main.py
   // the format for data is: 
   // [{outcome1: amount1, ..., outcomen: amountn,
   // Age:'<6mo'}, ..., {outcome1: amount1, ... , Age: '>7yr'}]
   var data = {{data|safe}}
   // x_labels is an array of all the ages
   var x_labels = {{x_labels|safe}}
   // y_labels is an array of all the outcomes 
   var y_labels = {{y_labels|safe}}

   data.forEach(function(d){
		// the y0 position (lowest position) for the first stacked bar will be 0 
		var y0 = 0;
		// we'll store everything in a list of dictionaries, d.outcomes
		d.outcomes = y_labels.map(function(name) {
		   // each outcome has a name, a y0 position (it's bottom)
		   // and a y1 position (it's top). 
		   res = {name: name, y0: y0, y1: y0 + d[name]};
		   // and we also have to update y0 for the next rectangle
		   y0 = y0 + d[name];
		   return res;});
		 // we also store the total height for this stacked bar
		 d.total = d.outcomes[d.outcomes.length - 1].y1;
		   })

   // ----------- EVERY CHART NEEDS SOME SETUP --------------
   //Width and height and margins for the plot 
   var margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;
   
   // set up the x axis scale to go from 0 to width
   // rangeRoundBands sets up the bar width with no 
   // fractional pixels, and the .1 specifies the distance between bars
   var x_scale = d3.scale.ordinal()
          .rangeRoundBands([0, width], .1);

   // this specifies the domain of the x axis, which is ordinal
   x_scale.domain(x_labels);

   // set up the y axis scale to go from 0 to height
   var y_scale = d3.scale.linear()
          .rangeRound([height, 0]);       

   // this specifies the domain of the y axis (0 to the height of
   // the tallest bar), which is linear 
   y_scale.domain([0, d3.max(data, function(d) { return d.total; })]);

   // set up the color scale (there are 6 outcomes) 
   var color = d3.scale.ordinal()
          .range(["#C8A57F", "#B0AE6E", "#77BA84", "#29BDBF",
   "#70B0F1", "#EB88E2"]);
   
   // create the x axis 
   var xAxis = d3.svg.axis()
               .scale(x_scale)
               .orient("bottom");

   // create the y axis
   var yAxis = d3.svg.axis()
              .scale(y_scale)
              .orient("left")
              .tickFormat(d3.format(".2s"));

   // associate the y labels with the color scale
   color.domain(y_labels);


	// ------- D3's DOM MANIPULATION MAGIC GOES HERE -------
    // the svg element is for drawing. We set its size based 
	// on the margins defined earlier
	var svg = d3.select("body").append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
		// and add a group that is inside the margins
        .append("g")
          // this makes sure that everything we do inside this group is translated to margin coordinates
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
       // draw the x axis (D3 handles the details in '.call')
       svg.append("g")
         .attr("class", "x axis")
         .attr("transform", "translate(0," + height + ")")
         .call(xAxis);
       // draw the y axis (D3 handles the details in '.call')
       svg.append("g")
         .attr("class", "y axis")
         .call(yAxis)
       .append("text")
         .attr("transform", "rotate(-90)")
         .attr("y", 6)
         .attr("dy", ".71em")
         .style("text-anchor", "end")
         .text("Number of Animals");

   // Create a group for each age
   var age = svg.selectAll(".Age")
      .data(data)
      .enter()
      .append("g")
        .attr("class", "g")
        .attr("x_position", function(d) {return x_scale(d.Age);})
        .attr("transform", function(d) {return "translate(" + x_scale(d.Age) + ",0)"; });

   // create a rectangle for each outcome (for each age)
   age.selectAll("rect")
   // bind the outcome data for that age to that rectangle
   .data(function(d) { return d.outcomes; })
   .enter().append("rect")
   .attr("width", x_scale.rangeBand())
   // use the outcome data to determine y position and height
   .attr("y", function(d) { return y_scale(d.y1); })
   .attr("height", function(d) { return y_scale(d.y0) - y_scale(d.y1); })
   // use the color scale to determine the fill color
   .attr("fill", function(d) { return color(d.name); })

  .on("mouseover", function(d) {
   //Get this bar's x/y values, then augment for the tooltip
   var xPosition = parseFloat(d3.select(this.parentNode).attr("x_position")) + 
       x_scale.rangeBand() / 2;
   var yPosition = parseFloat(d3.select(this).attr("y"));

   //Update the tooltip position and value
   d3.select("#tooltip")
       .style("left", xPosition + "px")
       .style("top", yPosition + "px")
       .select("#value")
       .text(d.y1-d.y0 + " animals were " + d.name + ".");

   //Show the tooltip (it's a div that is otherwise always hidden)
   d3.select("#tooltip").classed("hidden", false);
	})
	// and cause it to disappear when the mouse exits 
	.on("mouseout", function(d) {
	       d3.select("#tooltip").classed("hidden", true)});

    </script>
	</div>
</body>
</html>